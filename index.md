## The Motive

In the future, i want to monitor my home network with Wazuh and Suricata working together and setup all that on something like a Raspberry pi 4 and I want an easy way to see the alerts that are generated by Wazuh.

I could use the Wazuh integrations that are ready, like [Slack](https://documentation.wazuh.com/current/proof-of-concept-guide/poc-integrate-slack.html), but Discord is an App that I use daily and is perfect to use as an example on how to build a custom integration with Wazuh.

It's possible to create a custom-integration to send alerts to practically any place that has a webhook or any other form of receiving data via POST requests. Like Microsoft Teams, for example.

### The Ambient

I'm assuming that you already have Wazuh instaled and working. I'm working with a "All in one" installation in my kali vm, you can follow with any Linux distribution you like. If you are working with Wazuh distribud in clusters, you will have to replicate the entire configuration on all the node managers that you want the integration to work.

### Creating a webhook

The first thing to do is create a discord webhhok on **your** server chat
```markdown
- Open your server settings
- On "Integrations", click on "webhooks" to generate one
- Save the webhook link for now
```

### Creating the integration

cd into the Wazuh integrations folder.

You should see the default integrations scritps. 
```markdown
cd /var/ossec/integrations 
```
![](/docs/assets/images/01.png)

As you can see, that are two slack scritps, one is in bash and the other in python, the reason for that is that the bash one will work like a launcher for the python script.

Copy both of them and name it to **custom-discord**

- all custom integrations scripts names need to start with **custom-**
```markdown
cp slack custom-discord
cp slack.py custom-discord.py
```

The **Slack's** scripts were made by the Wazuh team to integrate with Slack via webhook, we can modify them to work with Discord webhook instead. Practically the only modification needed for that to work is going to be the in the **slack.py** **generate_msg()** function.

Before we talk code, i think it's good to understand how a integration is triggered and how you can control what types of alerts will trigger it.

Open the configuration file the Wazuh manager **ossec.conf** 
```markdown
vim /var/ossec/etc/ossec.conf
```

This block of xml is what activates the integration, you will need to insert this on the configuration file of the Wazug manager, **ossec.conf**. You can insert in any place you like, just be careful to not put in the middle of another block.
```markdown
  <integration>
    <name>custom-discord</name>
    <hook_url>https://discord.com/api/webhooks/hook</hook_url>
    <level>7</level>
    <alert_format>json</alert_format>
  </integration>
``` 
![](/docs/assets/images/02.png)

- The tag **name** in the line 354 is where we define the name of the script that will launch the python script.
- The tag **hook** is where you will need to place your webhook url.
- In the line 357 i can control what will trigger the integration, in my case is any Wazuh alert that is equal or greater than 07.

You can use the following options to trigger the alert:
```markdown
<group>suricata,sysmon</group> Only the rules of the group suricata and sysmon will trigger the integration.
<level>12</level> Only rules greate or equal to 12 will trigger.
<rule_id>1299,1300</rule_id> Only this rules will trigger.
```

### Customizing the script

After activating the integration, the next step would be customizing the custom-discord.py script.
open the script with your favorite text editor, in the line **76** you can replace the **generate_msg()** function and with the bellow function

This function will take an Wazuh alert as a argument and because the alerts are comming in json format we just need to fill the values to send to discord, when i build this function, i used [Birdie0](https://github.com/Birdie0) repository to help me understando how it worked and build the format that i like.

If you want to modify the contents of the alert, you need to modify the fields in the **payload**

I recommned that you check out Birdie repository [birdie0.github.io/discord-webhooks-guide/structure/embed/color.html](https://birdie0.github.io/discord-webhooks-guide/structure/embed/color.html) and explore to see if you like something different.

```markdown
def generate_msg(alert):

    level = alert['rule']['level']

    if (level <= 4):
        color = "3731970"
    elif (level >= 5 and level <= 12):
        color = "15919874"
    else:
        color = "15870466"

    if 'agentless' in alert:
        agent_ = 'agentless'
    else:
        agent_ = alert['agent']['name']

    payload = json.dumps({
      "embeds": [
        {
          "title": "Wazuh Alert - Rule {}".format(alert['rule']['id']),
          "color": "{}".format(color),
          "description": "{}".format(alert['rule']['description']),
          "fields": [
            {
              "name": "Agent",
              "value": "{}".format(agent_),
              "inline": True
            },
            {
              "name": "Location",
              "value": "{}".format(alert['location']),
              "inline": True
            },
            {
            "name": "Rule Level",
            "value": "{}".format(alert['rule']['level']),
            "inline": True
            }
          ]
        }
      ]
    })

    return payload
```
The alert format that this payload will generate in Discord:
![](/docs/assets/images/03.png)

I like to change the **debug()** function too, so i can control more freely when to save debug logs.
The default path for integrations log are in;
You can control that wi the variable **deb**
```markdown
/var/ossec/logs/integrations.log
```
```markdown
def debug(msg):
        # debug log
        deb = True
        if deb == True:
            msg = "{0}: {1}\n".format(now, msg)
            print(msg)
            f = open(log_file, "a")
            f.write(msg)
            f.close()
```
You will need to chance the scripts permissions and owners
```markdown
chmod 750 custom-*
chown root:wazuh custom-*
```
You will need te requests library, install it if you don't have it.
```markdown
pip3 install requests
```

### Creating a custom rule

Everything should be ready now, but before we restart the Wazuh manager to activate the integration, i like to create a custom rule that i can manually trigger to test the integration.

Create a file in /var/log named test.log
```markdown
touch /var/log/test.log
```
Open the ossec.conf file again and navigate to the botton, you should see a lot of *localfile* blocks, they indicate a path to a file that Wazuh will collect his logs from.

Insert this block
```markdown
  <localfile>
    <location>/var/log/test.log</location>
    <log_format>syslog</log_format>
  </localfile>
```
Next, create a custom rule, you will need to open the file designed for that **local_rules.xml**
```markdown
vim /var/ossec/etc/rules/local_rules.xml
```
Insert this rule
```markdown
  <rule id="119999" level="12">
    <regex>^test$</regex>
    <description>Test rule to configure integration</description>
  </rule>
```
Now every time that you will echo the word **test** in **/var/log/test.log** the rule should trigger.
To test that we can use the Binary that is exclusevely for that, **wazuh-logtest**

Run the binary and type the word test, you should see your rule getting iniciatted.
```markdown
/var/ossec/bin/wazuh-logtest
```
![](/docs/assets/images/04.png)

Restart the manager and trigger the alert, you should receive the alert on your Discord channel.
```markdown
/var/ossec/bin/wazuh-control restart
echo -e "test" /var/log/test.log
```
And the Alert
![](/docs/asstes/images/04.png)


### Debugging


```markdown
Syntax highlighted code block

# Header 1
## Header 2
### Header 3

- Bulleted
- List

1. Numbered
2. List

**Bold** and _Italic_ and `Code` text

[Link](url) and ![Image](src)
```

For more details see [Basic writing and formatting syntax](https://docs.github.com/en/github/writing-on-github/getting-started-with-writing-and-formatting-on-github/basic-writing-and-formatting-syntax).

### Jekyll Themes

Your Pages site will use the layout and styles from the Jekyll theme you have selected in your [repository settings](https://github.com/egn-egn/egn-egn.github.io/settings/pages). The name of this theme is saved in the Jekyll `_config.yml` configuration file.

### Support or Contact

Having trouble with Pages? Check out our [documentation](https://docs.github.com/categories/github-pages-basics/) or [contact support](https://support.github.com/contact) and weâ€™ll help you sort it out.
